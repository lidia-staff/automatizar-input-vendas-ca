<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Connect â€” Painel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #232323;
    --border: #2e2e2e;
    --accent: #00e5a0;
    --accent-dim: rgba(0,229,160,0.12);
    --danger: #ff4f4f;
    --warn: #f5a623;
    --text: #e8e8e8;
    --muted: #666;
    --radius: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; min-height: 100vh; }

  /* LAYOUT */
  .app { display: flex; min-height: 100vh; }
  .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px 0; flex-shrink: 0; display: flex; flex-direction: column; }
  .main { flex: 1; overflow-y: auto; }

  /* SIDEBAR */
  .logo { padding: 0 20px 24px; border-bottom: 1px solid var(--border); }
  .logo h1 { font-size: 13px; font-weight: 600; letter-spacing: .05em; text-transform: uppercase; color: var(--accent); }
  .logo p { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .nav { padding: 16px 0; flex: 1; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; cursor: pointer; color: var(--muted); font-size: 13px; font-weight: 500; transition: all .15s; border-left: 2px solid transparent; }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: var(--accent-dim); }
  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  /* COMPANY SELECTOR */
  .company-selector { padding: 12px; border-top: 1px solid var(--border); }
  .company-selector select { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: var(--radius); font-size: 12px; cursor: pointer; }

  /* PAGE */
  .page { display: none; padding: 32px; max-width: 960px; }
  .page.active { display: block; }
  .page-header { margin-bottom: 28px; }
  .page-header h2 { font-size: 22px; font-weight: 600; }
  .page-header p { color: var(--muted); margin-top: 4px; font-size: 13px; }

  /* CARDS */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .card-title { font-size: 12px; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }

  /* STATS */
  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
  .stat { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; }
  .stat-value { font-size: 28px; font-weight: 600; font-family: 'DM Mono', monospace; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 2px; text-transform: uppercase; letter-spacing: .05em; }

  /* TABLE */
  table { width: 100%; border-collapse: collapse; }
  th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* BADGE */
  .badge { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 20px; }
  .badge-green { background: rgba(0,229,160,.15); color: var(--accent); }
  .badge-red { background: rgba(255,79,79,.15); color: var(--danger); }
  .badge-yellow { background: rgba(245,166,35,.15); color: var(--warn); }
  .badge-gray { background: rgba(255,255,255,.08); color: var(--muted); }

  /* BUTTONS */
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all .15s; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #00c98a; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: rgba(255,79,79,.15); color: var(--danger); border: 1px solid rgba(255,79,79,.3); }
  .btn-danger:hover { background: rgba(255,79,79,.25); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn:disabled { opacity: .4; cursor: not-allowed; }
  .btn-group { display: flex; gap: 8px; }

  /* FORMS */
  .form-group { margin-bottom: 16px; }
  label { font-size: 12px; font-weight: 500; color: var(--muted); display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .04em; }
  input, select, textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px; border-radius: var(--radius); font-size: 13px; font-family: inherit; transition: border-color .15s; }
  input:focus, select:focus { outline: none; border-color: var(--accent); }

  /* UPLOAD ZONE */
  .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 40px; text-align: center; cursor: pointer; transition: all .2s; }
  .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: var(--accent-dim); }
  .upload-zone-icon { font-size: 32px; margin-bottom: 12px; }
  .upload-zone p { color: var(--muted); font-size: 13px; }
  .upload-zone strong { color: var(--accent); }

  /* TOAST */
  .toast-container { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
  .toast { background: var(--surface); border: 1px solid var(--border); padding: 12px 16px; border-radius: var(--radius); font-size: 13px; max-width: 340px; box-shadow: 0 4px 20px rgba(0,0,0,.4); animation: slideIn .2s ease; }
  .toast-success { border-left: 3px solid var(--accent); }
  .toast-error { border-left: 3px solid var(--danger); }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: flex; align-items: center; justify-content: center; z-index: 100; display: none; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 28px; width: 480px; max-width: 95vw; }
  .modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 20px; }

  /* LOADING */
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.2); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-detail { background: rgba(255,79,79,.08); border: 1px solid rgba(255,79,79,.2); border-radius: var(--radius); padding: 10px 12px; font-size: 12px; color: #ff8888; font-family: 'DM Mono', monospace; margin-top: 6px; }
  .empty-state { text-align: center; padding: 48px; color: var(--muted); }
  .empty-state-icon { font-size: 36px; margin-bottom: 12px; }
  .section-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }

  /* PIN OVERLAY */
  #pinOverlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.88);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }
  #pinOverlay.open { display: flex; }
  .pin-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 40px 32px;
    width: 340px;
    text-align: center;
  }
  #pinInput {
    text-align: center;
    font-size: 22px;
    letter-spacing: 8px;
    padding: 12px;
  }
</style>
</head>
<body>

<!-- PIN OVERLAY -->
<div id="pinOverlay">
  <div class="pin-box">
    <div style="font-size:40px;margin-bottom:12px">ğŸ”’</div>
    <h2 id="pinCompanyName" style="font-size:18px;font-weight:600;margin-bottom:6px"></h2>
    <p style="color:var(--muted);font-size:13px;margin-bottom:24px">Digite o PIN de acesso para continuar</p>
    <div class="form-group">
      <input
        id="pinInput"
        type="password"
        inputmode="numeric"
        maxlength="20"
        placeholder="â€¢â€¢â€¢â€¢"
        onkeydown="if(event.key==='Enter') verifyPin()"
      >
    </div>
    <div id="pinError" style="color:var(--danger);font-size:12px;margin-bottom:12px;min-height:16px"></div>
    <button onclick="verifyPin()" class="btn btn-primary" style="width:100%">Entrar</button>
  </div>
</div>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <h1>CA AutomaÃ§Ã£o</h1>
      <p>Vendas â†’ Conta Azul</p>
    </div>
    <nav class="nav">
      <div class="nav-item active" onclick="showPage('dashboard', event)">
        <span class="nav-icon">ğŸ“Š</span> Dashboard
      </div>
      <div class="nav-item" onclick="showPage('upload', event)">
        <span class="nav-icon">ğŸ“¤</span> Upload
      </div>
      <div class="nav-item" onclick="showPage('batches', event)">
        <span class="nav-icon">ğŸ“¦</span> Lotes
      </div>
      <div class="nav-item" onclick="showPage('config', event)">
        <span class="nav-icon">âš™ï¸</span> ConfiguraÃ§Ãµes
      </div>
    </nav>
    <div class="company-selector" id="companySelectorWrap">
      <select id="companySelect" onchange="onCompanyChange()">
        <option value="">Carregando...</option>
      </select>
      <div id="companyFixed" style="display:none;padding:8px 4px;font-size:13px;font-weight:600;color:var(--text)"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>VisÃ£o geral das vendas e configuraÃ§Ãµes</p>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="stat-total">â€”</div>
          <div class="stat-label">Total de Vendas</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-enviadas">â€”</div>
          <div class="stat-label">Enviadas ao CA</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-erros" style="color:var(--danger)">â€”</div>
          <div class="stat-label">Com Erro</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Status da Empresa</div>
        <div id="company-status">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Mapeamento de Contas</div>
        <div id="payment-mapping-summary">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div id="page-upload" class="page">
      <div class="page-header">
        <h2>Upload de Planilha</h2>
        <p>Envie uma planilha Excel com as vendas</p>
      </div>
      <div class="card">
        <div class="form-group">
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-zone-icon">ğŸ“‚</div>
            <p><strong>Clique para selecionar</strong> ou arraste a planilha aqui</p>
            <p style="margin-top:6px;font-size:12px">Formatos aceitos: .xlsx</p>
          </div>
          <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="onFileSelect(event)">
        </div>
        <div id="upload-file-info" style="display:none" class="form-group">
          <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:var(--radius)">
            <span>ğŸ“„</span>
            <span id="upload-filename" style="flex:1;font-size:13px"></span>
            <button class="btn btn-secondary btn-sm" onclick="clearFile()">âœ• Remover</button>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnUpload" onclick="doUpload()" disabled>
            ğŸ“¤ Enviar Planilha
          </button>
        </div>
        <div id="upload-result" style="margin-top:16px;display:none"></div>
      </div>
    </div>

    <!-- BATCHES -->
    <div id="page-batches" class="page">
      <div class="page-header">
        <div class="section-row">
          <div>
            <h2>Lotes de Vendas</h2>
            <p style="margin-top:4px;color:var(--muted);font-size:13px">Gerencie os lotes enviados</p>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="loadBatches()">ğŸ”„ Atualizar</button>
        </div>
      </div>
      <div id="batches-list">
        <div class="empty-state"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- CONFIG -->
    <div id="page-config" class="page">
      <div class="page-header">
        <h2>ConfiguraÃ§Ãµes</h2>
        <p>Configure contas financeiras por forma de pagamento</p>
      </div>

      <!-- Contas disponÃ­veis -->
      <div class="card">
        <div class="card-title">Contas Financeiras no Conta Azul</div>
        <div id="ca-accounts-list">
          <button class="btn btn-secondary btn-sm" onclick="loadCAAccounts()">Carregar contas do CA</button>
        </div>
      </div>

      <!-- Mapeamento -->
      <div class="card">
        <div class="section-row">
          <div class="card-title" style="margin:0">Mapeamento Forma de Pagamento â†’ Conta</div>
          <button class="btn btn-secondary btn-sm" onclick="loadPaymentMappings()">ğŸ”„</button>
        </div>
        <div id="payment-mappings-list" style="margin-bottom:16px">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openMappingModal()">+ Adicionar Mapeamento</button>
      </div>

      <!-- Conta padrÃ£o -->
      <div class="card">
        <div class="card-title">Conta Financeira PadrÃ£o (Fallback)</div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">Usada quando nÃ£o hÃ¡ mapeamento especÃ­fico</p>
        <div class="form-group">
          <label>UUID da Conta</label>
          <input type="text" id="defaultAccountInput" placeholder="Cole o UUID da conta financeira">
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveDefaultAccount()">Salvar Conta PadrÃ£o</button>
      </div>

      <!-- Produto PadrÃ£o -->
      <div class="card">
        <div class="card-title">âš ï¸ Produto/ServiÃ§o PadrÃ£o <span style="color:var(--danger);font-size:11px">(OBRIGATÃ“RIO)</span></div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">Todas as vendas serÃ£o registradas com este produto. Configure antes de enviar vendas.</p>
        
        <div id="products-list" style="margin-bottom:16px">
          <button class="btn btn-secondary btn-sm" onclick="loadCAProducts()">ğŸ“¦ Carregar Produtos do CA</button>
        </div>
        
        <div class="form-group">
          <label>Produto Selecionado</label>
          <select id="defaultProductSelect" style="margin-bottom:8px" onchange="onProductSelectChange()">
            <option value="">-- Selecione um produto --</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
          <label>OU cole o UUID do produto manualmente</label>
          <input type="text" id="manualProductInput" placeholder="UUID do produto (ex: 4cf9d5c3-d20d-4dc9-...)">
          <p style="color:var(--muted);font-size:11px;margin-top:4px">Use esta opÃ§Ã£o se a API nÃ£o retornar produtos. Encontre o UUID no DevTools do navegador.</p>
        </div>
        
        <button class="btn btn-primary btn-sm" onclick="saveDefaultProduct()">âœ… Salvar Produto PadrÃ£o</button>
      </div>

      <!-- PIN de Acesso -->
      <div class="card">
        <div class="card-title">ğŸ”’ PIN de Acesso</div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">
          Proteja o painel deste cliente com um PIN numÃ©rico. O cliente precisarÃ¡ digitar o PIN ao acessar o painel.
          Deixe em branco para remover o PIN atual.
        </p>
        <div class="form-group">
          <label>Novo PIN (mÃ­nimo 4 dÃ­gitos)</label>
          <input type="password" id="pinNewInput" placeholder="Ex: 1234" maxlength="20" inputmode="numeric" style="letter-spacing:4px;font-size:18px">
        </div>
        <button class="btn btn-primary btn-sm" onclick="savePin()">ğŸ”’ Salvar PIN</button>
        <button class="btn btn-danger btn-sm" onclick="removePin()" style="margin-left:8px">ğŸ”“ Remover PIN</button>
      </div>

      <!-- OAuth -->
      <div class="card">
        <div class="card-title">AutenticaÃ§Ã£o Conta Azul</div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">Autorize o acesso ao Conta Azul da empresa</p>
        <button class="btn btn-secondary" onclick="doOAuth()">ğŸ” Autorizar Conta Azul</button>
      </div>
    </div>

  </main>
</div>

<!-- MODAL MAPEAMENTO -->
<div class="modal-overlay" id="mappingModal">
  <div class="modal">
    <h3>Configurar Mapeamento</h3>
    <div class="form-group">
      <label>Forma de Pagamento</label>
      <select id="mappingKey">
        <option value="PIX">PIX</option>
        <option value="CARTAO_CREDITO">CartÃ£o de CrÃ©dito</option>
        <option value="CARTAO_DEBITO">CartÃ£o de DÃ©bito</option>
        <option value="BOLETO">Boleto</option>
        <option value="TRANSFERENCIA">TransferÃªncia</option>
        <option value="DINHEIRO">Dinheiro</option>
        <option value="OUTRO">Outro</option>
      </select>
    </div>
    <div class="form-group">
      <label>Conta Financeira (UUID)</label>
      <select id="mappingAccount">
        <option value="">Selecione uma conta...</option>
      </select>
    </div>
    <div class="form-group">
      <label>Label (opcional)</label>
      <input type="text" id="mappingLabel" placeholder="Ex: Stone PIX">
    </div>
    <div class="btn-group" style="margin-top:8px">
      <button class="btn btn-primary" onclick="saveMapping()">Salvar</button>
      <button class="btn btn-secondary" onclick="closeMappingModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '';  // vazio = mesma origem

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCompanyId = null;
let caAccounts = [];
let _pendingSlug = null;

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
  await loadCompanies();
  setupUploadZone();
});

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(page, event) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (event && event.currentTarget) event.currentTarget.classList.add('active');
  
  if (page === 'dashboard') loadDashboard();
  if (page === 'batches') loadBatches();
  if (page === 'config') { loadCAAccounts(); loadPaymentMappings(); loadDefaultAccount(); loadPinStatus(); }
}

// â”€â”€â”€ PIN DE ACESSO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkPinRequired(slug, companyName) {
  // Verifica se jÃ¡ autenticou nesta sessÃ£o
  const sessionKey = `pin_ok_${slug}`;
  if (sessionStorage.getItem(sessionKey) === 'true') return true;

  // Consulta se tem PIN configurado
  try {
    const res = await fetch(`${API}/v1/companies/by-slug/${slug}`);
    const data = await res.json();
    if (!data.has_pin) return true; // sem PIN, libera direto
  } catch(e) {
    return true; // em caso de erro, nÃ£o bloqueia
  }

  // Tem PIN â€” exibe modal
  _pendingSlug = slug;
  document.getElementById('pinCompanyName').textContent = companyName || slug;
  document.getElementById('pinInput').value = '';
  document.getElementById('pinError').textContent = '';
  document.getElementById('pinOverlay').classList.add('open');
  setTimeout(() => document.getElementById('pinInput').focus(), 100);
  return false;
}

async function verifyPin() {
  const pin = document.getElementById('pinInput').value.trim();
  if (!pin) {
    document.getElementById('pinError').textContent = 'Digite o PIN para continuar.';
    return;
  }

  try {
    const res = await fetch(`${API}/v1/companies/by-slug/${_pendingSlug}/verify-pin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pin })
    });
    const data = await res.json();

    if (data.ok) {
      sessionStorage.setItem(`pin_ok_${_pendingSlug}`, 'true');
      document.getElementById('pinOverlay').classList.remove('open');
      loadDashboard();
    } else {
      document.getElementById('pinError').textContent = 'PIN incorreto. Tente novamente.';
      document.getElementById('pinInput').value = '';
      document.getElementById('pinInput').focus();
    }
  } catch(e) {
    document.getElementById('pinError').textContent = 'Erro ao verificar PIN. Tente novamente.';
  }
}

async function savePin() {
  const pin = document.getElementById('pinNewInput').value.trim();
  if (!pin) return toast('Digite um PIN para salvar', 'error');
  if (pin.length < 4) return toast('PIN deve ter no mÃ­nimo 4 caracteres', 'error');
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ access_pin: pin })
    });
    if (!res.ok) throw new Error('Erro ao salvar');
    toast('ğŸ”’ PIN definido com sucesso!', 'success');
    document.getElementById('pinNewInput').value = '';
    loadPinStatus();
  } catch(e) {
    toast('Erro ao salvar PIN', 'error');
  }
}

async function removePin() {
  if (!confirm('Remover o PIN de acesso? O painel ficarÃ¡ pÃºblico.')) return;
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ access_pin: '' })
    });
    if (!res.ok) throw new Error('Erro ao remover');
    toast('ğŸ”“ PIN removido. Painel agora pÃºblico.', 'success');
    loadPinStatus();
  } catch(e) {
    toast('Erro ao remover PIN', 'error');
  }
}

async function loadPinStatus() {
  if (!currentCompanyId) return;
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`);
    const data = await res.json();
    const card = document.querySelector('#page-config .card:nth-of-type(5) .card-title');
    if (card) {
      card.textContent = data.has_pin ? 'ğŸ”’ PIN de Acesso (ativo)' : 'ğŸ”“ PIN de Acesso (sem PIN)';
    }
  } catch(e) {}
}

// â”€â”€â”€ COMPANY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCompanies() {
  try {
    const res = await fetch(`${API}/v1/companies`);
    const companies = await res.json();
    const sel = document.getElementById('companySelect');
    sel.innerHTML = companies.map(c =>
      `<option value="${c.id}" data-slug="${c.slug || ''}">${c.name}</option>`
    ).join('');

    // Auto-seleciona pelo slug da URL (ex: /painel/body-face)
    const pathParts = window.location.pathname.split('/painel/');
    const pathSlug = pathParts.length > 1 ? pathParts[1].replace(/\/$/,'') : '';
    let matched = false;
    if (pathSlug) {
      const toSlug = s => (s||'').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
      const company = companies.find(c => c.slug === pathSlug)
                   || companies.find(c => toSlug(c.name) === pathSlug);
      if (company) {
        sel.value = String(company.id);
        currentCompanyId = String(company.id);
        matched = true;
      }
    }
    if (!matched && companies.length > 0) {
      sel.value = String(companies[0].id);
      currentCompanyId = String(companies[0].id);
    }

    // Se veio por slug: esconde dropdown, mostra nome fixo e verifica PIN
    if (pathSlug && matched) {
      const company = companies.find(c => String(c.id) === String(currentCompanyId));
      document.getElementById('companySelect').style.display = 'none';
      const fixed = document.getElementById('companyFixed');
      fixed.style.display = 'block';
      fixed.textContent = company ? company.name : '';

      // Verificar PIN antes de carregar dashboard
      const pinOk = await checkPinRequired(pathSlug, company ? company.name : '');
      if (pinOk) loadDashboard();
      // Se pinOk = false: modal foi aberto, verifyPin() chamarÃ¡ loadDashboard()
    } else {
      loadDashboard();
    }
  } catch(e) {
    toast('Erro ao carregar empresas', 'error');
  }
}

function onCompanyChange() {
  currentCompanyId = document.getElementById('companySelect').value;
  loadDashboard();
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  if (!currentCompanyId) return;
  
  try {
    const [salesRes, companyRes, mappingRes] = await Promise.all([
      fetch(`${API}/v1/sales?company_id=${currentCompanyId}`),
      fetch(`${API}/v1/companies/${currentCompanyId}`),
      fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts`),
    ]);
    
    const sales = await salesRes.json();
    const company = await companyRes.json();
    const mapping = await mappingRes.json();
    
    // Stats
    const total = sales.length;
    const enviadas = sales.filter(s => s.status === 'ENVIADA_CA').length;
    const erros = sales.filter(s => s.status === 'ERRO_ENVIO_CA').length;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-enviadas').textContent = enviadas;
    document.getElementById('stat-erros').textContent = erros;
    
    // Status empresa
    const hasToken = company.has_token;
    const hasAccount = company.ca_financial_account_id;
    document.getElementById('company-status').innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;align-items:center;gap:10px">
          ${hasToken ? '<span class="badge badge-green">âœ“ OAuth Ativo</span>' : '<span class="badge badge-red">âœ— Sem OAuth</span>'}
          ${hasAccount ? '<span class="badge badge-green">âœ“ Conta PadrÃ£o</span>' : '<span class="badge badge-yellow">âš  Sem Conta PadrÃ£o</span>'}
          <span style="color:var(--muted);font-size:12px">${company.name}</span>
        </div>
        ${!hasToken ? `<a href="/api/contaazul/start?company_id=${currentCompanyId}" target="_blank" class="btn btn-secondary btn-sm" style="width:fit-content">ğŸ” Autorizar Conta Azul</a>` : ''}
      </div>`;
    
    // Mapeamentos
    const maps = mapping.mappings || [];
    if (maps.length === 0) {
      document.getElementById('payment-mapping-summary').innerHTML =
        '<p style="color:var(--warn);font-size:13px">âš ï¸ Nenhum mapeamento configurado. Configure em ConfiguraÃ§Ãµes.</p>';
    } else {
      const labels = { PIX:'PIX', CARTAO_CREDITO:'CartÃ£o CrÃ©dito', CARTAO_DEBITO:'CartÃ£o DÃ©bito', BOLETO:'Boleto', TRANSFERENCIA:'TransferÃªncia', DINHEIRO:'Dinheiro', OUTRO:'Outro' };
      document.getElementById('payment-mapping-summary').innerHTML = `
        <table>
          <tr><th>Pagamento</th><th>Conta (UUID)</th><th>Label</th></tr>
          ${maps.map(m => `<tr>
            <td><span class="badge badge-gray">${labels[m.payment_method_key] || m.payment_method_key}</span></td>
            <td><code style="font-size:11px;color:var(--muted)">${m.ca_financial_account_id.substring(0,18)}...</code></td>
            <td>${m.label || 'â€”'}</td>
          </tr>`).join('')}
        </table>`;
    }
  } catch(e) {
    console.error(e);
  }
}

// â”€â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedFile = null;

function setupUploadZone() {
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if (file) setFile(file);
  });
}

function onFileSelect(e) {
  const file = e.target.files[0];
  if (file) setFile(file);
}

function setFile(file) {
  selectedFile = file;
  document.getElementById('upload-filename').textContent = file.name;
  document.getElementById('upload-file-info').style.display = 'block';
  document.getElementById('btnUpload').disabled = false;
}

function clearFile() {
  selectedFile = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('upload-file-info').style.display = 'none';
  document.getElementById('btnUpload').disabled = true;
  document.getElementById('upload-result').style.display = 'none';
}

async function doUpload() {
  if (!selectedFile || !currentCompanyId) return;
  const btn = document.getElementById('btnUpload');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Enviando...';

  const fd = new FormData();
  fd.append('company_id', currentCompanyId);
  fd.append('file', selectedFile);

  try {
    const res = await fetch(`${API}/v1/uploads`, { method: 'POST', body: fd });
    const data = await res.json();

    if (!res.ok) {
      if (data.detail && data.detail.includes('config_incompleta')) {
        const msg = data.detail.replace('config_incompleta: ', '');
        document.getElementById('upload-result').style.display = 'block';
        document.getElementById('upload-result').innerHTML = `
          <div class="error-detail">
            <strong>âš ï¸ ConfiguraÃ§Ã£o Incompleta</strong><br>
            ${msg}<br><br>
            <button class="btn btn-primary btn-sm" onclick="showPage('config', null)">Ir para ConfiguraÃ§Ãµes</button>
          </div>`;
        throw new Error(msg);
      }
      throw new Error(data.detail || 'Erro no upload');
    }

    document.getElementById('upload-result').style.display = 'block';
    document.getElementById('upload-result').innerHTML = `
      <div class="card" style="background:var(--accent-dim);border-color:var(--accent)">
        <div style="font-weight:600;margin-bottom:10px;color:var(--accent)">âœ… Upload realizado!</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
          <div>ğŸ“¦ Lote: <strong>#${data.batch_id}</strong></div>
          <div>ğŸ“‹ Vendas criadas: <strong>${data.sales_created}</strong></div>
          <div>â³ Aguardando aprovaÃ§Ã£o: <strong>${data.awaiting_approval}</strong></div>
          <div style="color:${data.with_error > 0 ? 'var(--danger)' : 'inherit'}">âŒ Com erro: <strong>${data.with_error}</strong></div>
        </div>
        ${data.awaiting_approval > 0 ? `
        <div style="margin-top:14px;display:flex;gap:8px">
          <button class="btn btn-primary btn-sm" onclick="quickApprove(${data.batch_id})">âœ“ Aprovar Lote #${data.batch_id}</button>
          <button class="btn btn-secondary btn-sm" onclick="showPage('batches', null);loadBatches()">Ver Lotes</button>
        </div>` : ''}
      </div>`;

    toast(`âœ… ${data.sales_created} vendas criadas no lote #${data.batch_id}`, 'success');
    clearFile();
  } catch(e) {
    toast(e.message, 'error');
    if (!document.getElementById('upload-result').innerHTML.includes('ConfiguraÃ§Ã£o Incompleta')) {
      document.getElementById('upload-result').style.display = 'block';
      document.getElementById('upload-result').innerHTML = `<div class="error-detail">${e.message}</div>`;
    }
  } finally {
    btn.innerHTML = 'ğŸ“¤ Enviar Planilha';
    btn.disabled = false;
  }
}

async function quickApprove(batchId) {
  try {
    const res = await fetch(`${API}/v1/batches/${batchId}/approve`, { method: 'POST', body: '' });
    const data = await res.json();
    toast(`âœ… ${data.approved} vendas aprovadas`, 'success');
    loadDashboard();
  } catch(e) {
    toast('Erro ao aprovar', 'error');
  }
}

// â”€â”€â”€ BATCHES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBatches() {
  if (!currentCompanyId) return;
  const container = document.getElementById('batches-list');
  container.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';

  try {
    const res = await fetch(`${API}/v1/sales?company_id=${currentCompanyId}`);
    const sales = await res.json();

    if (sales.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>Nenhuma venda encontrada</p></div>';
      return;
    }

    const batches = {};
    sales.forEach(s => {
      if (!batches[s.batch_id]) batches[s.batch_id] = { id: s.batch_id, sales: [] };
      batches[s.batch_id].sales.push(s);
    });

    container.innerHTML = Object.values(batches).reverse().map(b => {
      const total = b.sales.length;
      const enviadas = b.sales.filter(s => s.status === 'ENVIADA_CA').length;
      const erros = b.sales.filter(s => s.status === 'ERRO_ENVIO_CA').length;
      const prontas = b.sales.filter(s => s.status === 'PRONTA').length;
      const aguardando = b.sales.filter(s => s.status === 'AGUARDANDO_APROVACAO').length;

      return `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
          <div>
            <div style="font-weight:600;font-size:15px">Lote #${b.id}</div>
            <div style="color:var(--muted);font-size:12px;margin-top:2px">${total} vendas</div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
            ${enviadas > 0 ? `<span class="badge badge-green">âœ“ ${enviadas} enviadas</span>` : ''}
            ${erros > 0 ? `<span class="badge badge-red">âœ— ${erros} erros</span>` : ''}
            ${prontas > 0 ? `<span class="badge badge-gray">â© ${prontas} prontas</span>` : ''}
            ${aguardando > 0 ? `<span class="badge badge-yellow">â³ ${aguardando} aguardando</span>` : ''}
          </div>
        </div>
        <div class="btn-group">
          ${aguardando > 0 ? `<button class="btn btn-secondary btn-sm" onclick="approveBatch(${b.id})">âœ“ Aprovar (${aguardando})</button>` : ''}
          ${prontas > 0 ? `<button class="btn btn-primary btn-sm" onclick="sendBatch(${b.id}, this)">ğŸš€ Enviar ao CA (${prontas})</button>` : ''}
          ${erros > 0 ? `<button class="btn btn-danger btn-sm" onclick="toggleErrors(${b.id})">Ver erros</button>` : ''}
        </div>
        <div id="errors-${b.id}" style="display:none;margin-top:14px">
          ${b.sales.filter(s => s.status === 'ERRO_ENVIO_CA').map(s => `
            <div style="margin-bottom:8px">
              <div style="font-size:13px;font-weight:500">${s.customer_name} â€” R$ ${parseFloat(s.total_amount).toFixed(2)}</div>
              <div class="error-detail">${s.error_summary || 'Sem detalhes'}</div>
            </div>`).join('')}
        </div>
      </div>`;
    }).join('');

  } catch(e) {
    container.innerHTML = `<div class="error-detail">${e.message}</div>`;
  }
}

function toggleErrors(batchId) {
  const el = document.getElementById('errors-' + batchId);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function approveBatch(batchId) {
  try {
    const res = await fetch(`${API}/v1/batches/${batchId}/approve`, { method: 'POST', body: '' });
    const data = await res.json();
    toast(`âœ… ${data.approved} vendas aprovadas`, 'success');
    loadBatches();
  } catch(e) {
    toast('Erro ao aprovar', 'error');
  }
}

async function sendBatch(batchId, btn) {
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Enviando...';
  try {
    const res = await fetch(`${API}/v1/batches/${batchId}/send_to_ca`, { method: 'POST', body: '' });
    const data = await res.json();
    if (data.errors > 0) {
      toast(`âš ï¸ ${data.sent} enviadas, ${data.errors} erros`, 'error');
    } else {
      toast(`âœ… ${data.sent} vendas enviadas ao Conta Azul!`, 'success');
    }
    loadBatches();
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  } finally {
    btn.innerHTML = 'ğŸš€ Enviar ao CA';
    btn.disabled = false;
  }
}

// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCAAccounts() {
  if (!currentCompanyId) return;
  const el = document.getElementById('ca-accounts-list');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/ca/financial-accounts`);
    const data = await res.json();
    const allAccounts = data.itens || data || [];
    
    caAccounts = allAccounts.filter(a => a.ativo === true || a.active === true);

    const sel = document.getElementById('mappingAccount');
    sel.innerHTML = '<option value="">Selecione...</option>' +
      caAccounts.map(a =>
        `<option value="${a.id}">${a.nome} (${a.tipo})</option>`
      ).join('');

    el.innerHTML = `
      <table>
        <tr><th>Nome</th><th>Tipo</th><th>UUID</th></tr>
        ${caAccounts.map(a => `<tr>
          <td>${a.nome}</td>
          <td><span class="badge badge-gray">${a.tipo}</span></td>
          <td><code style="font-size:11px;color:var(--muted)">${a.id}</code></td>
        </tr>`).join('')}
      </table>
      <p style="color:var(--muted);font-size:11px;margin-top:8px">
        Exibindo apenas contas ativas (${caAccounts.length} de ${allAccounts.length} total)
      </p>`;
  } catch(e) {
    el.innerHTML = `<div class="error-detail">${e.message}</div>`;
  }
}

async function loadPaymentMappings() {
  if (!currentCompanyId) return;
  const el = document.getElementById('payment-mappings-list');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts`);
    const data = await res.json();
    const maps = data.mappings || [];

    if (maps.length === 0) {
      el.innerHTML = '<p style="color:var(--muted);font-size:13px">Nenhum mapeamento configurado.</p>';
      return;
    }

    const labels = { PIX:'PIX', CARTAO_CREDITO:'CartÃ£o CrÃ©dito', CARTAO_DEBITO:'CartÃ£o DÃ©bito',
                     BOLETO:'Boleto', TRANSFERENCIA:'TransferÃªncia', DINHEIRO:'Dinheiro', OUTRO:'Outro' };

    el.innerHTML = `
      <table>
        <tr><th>Pagamento</th><th>Label</th><th>Conta (UUID)</th><th></th></tr>
        ${maps.map(m => `<tr>
          <td><span class="badge badge-gray">${labels[m.payment_method_key] || m.payment_method_key}</span></td>
          <td>${m.label || 'â€”'}</td>
          <td><code style="font-size:11px;color:var(--muted)">${m.ca_financial_account_id.substring(0,22)}...</code></td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteMapping('${m.payment_method_key}')">âœ•</button></td>
        </tr>`).join('')}
      </table>`;
  } catch(e) {
    el.innerHTML = `<div class="error-detail">${e.message}</div>`;
  }
}

async function loadDefaultAccount() {
  if (!currentCompanyId) return;
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`);
    const c = await res.json();
    if (c.ca_financial_account_id) {
      document.getElementById('defaultAccountInput').value = c.ca_financial_account_id;
    }
  } catch(e) {}
}

async function saveDefaultAccount() {
  const uuid = document.getElementById('defaultAccountInput').value.trim();
  if (!uuid) return toast('Informe o UUID da conta', 'error');
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/ca/financial-account`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ca_financial_account_id: uuid })
    });
    if (!res.ok) throw new Error('Erro ao salvar');
    toast('âœ… Conta padrÃ£o salva!', 'success');
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  }
}

// â”€â”€â”€ PRODUTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCAProducts() {
  if (!currentCompanyId) return;
  const el = document.getElementById('products-list');
  el.innerHTML = '<div class="spinner"></div>';
  
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/ca/products?busca=`);
    if (!res.ok) throw new Error('Erro ao carregar produtos');
    
    const data = await res.json();
    const allProducts = data.items || data.itens || [];
    
    const products = allProducts.filter(p => 
      p.status === 'ATIVO' || p.ativo === true || p.active === true || 
      (!p.status && !p.hasOwnProperty('ativo'))
    );
    
    if (products.length === 0) {
      el.innerHTML = '<div class="error-detail">âš ï¸ Nenhum produto ativo encontrado. Use o campo manual abaixo ou crie produtos no Conta Azul.</div>';
      return;
    }
    
    const sel = document.getElementById('defaultProductSelect');
    sel.innerHTML = '<option value="">-- Selecione um produto --</option>' +
      products.map(p => 
        `<option value="${p.id}">${p.name || p.description || p.nome} ${p.code ? '(' + p.code + ')' : ''}</option>`
      ).join('');
    
    el.innerHTML = `
      <table>
        <tr><th>Nome/DescriÃ§Ã£o</th><th>CÃ³digo</th><th>UUID</th></tr>
        ${products.map(p => `<tr>
          <td>${p.name || p.description || p.nome || '-'}</td>
          <td>${p.code || p.cnaeCode || '-'}</td>
          <td><code style="font-size:10px;color:var(--muted)">${p.id}</code></td>
        </tr>`).join('')}
      </table>`;
    
    toast(`${products.length} produto(s) ativo(s) carregado(s)`, 'success');
  } catch(e) {
    el.innerHTML = `<div class="error-detail">${e.message}</div>`;
    toast('Erro ao carregar produtos', 'error');
  }
}

function onProductSelectChange() {
  const sel = document.getElementById('defaultProductSelect');
  if (sel.value) {
    document.getElementById('manualProductInput').value = '';
  }
}

async function saveDefaultProduct() {
  const selectedId = document.getElementById('defaultProductSelect').value;
  const manualId = document.getElementById('manualProductInput').value.trim();
  const productId = selectedId || manualId;
  
  if (!productId) return toast('Selecione um produto ou cole o UUID manualmente', 'error');
  
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ default_item_id: productId })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Erro ao salvar');
    }
    toast('âœ… Produto padrÃ£o configurado!', 'success');
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  }
}

// â”€â”€â”€ MAPEAMENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMappingModal() {
  document.getElementById('mappingModal').classList.add('open');
}
function closeMappingModal() {
  document.getElementById('mappingModal').classList.remove('open');
}

async function saveMapping() {
  const key = document.getElementById('mappingKey').value;
  const accountId = document.getElementById('mappingAccount').value;
  const label = document.getElementById('mappingLabel').value;

  if (!accountId) return toast('Selecione uma conta', 'error');

  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payment_method_key: key, ca_financial_account_id: accountId, label: label || null })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Erro');
    }
    toast('âœ… Mapeamento salvo!', 'success');
    closeMappingModal();
    loadPaymentMappings();
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  }
}

async function deleteMapping(key) {
  try {
    await fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts/${key}`, { method: 'DELETE' });
    toast(`ğŸ—‘ï¸ Mapeamento ${key} removido`, 'success');
    loadPaymentMappings();
    loadDashboard();
  } catch(e) {
    toast('Erro ao remover', 'error');
  }
}

function doOAuth() {
  if (!currentCompanyId) return toast('Selecione uma empresa', 'error');
  window.open(`/api/contaazul/start?company_id=${currentCompanyId}`, '_blank');
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'success') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}
</script>
</body>
</html>
