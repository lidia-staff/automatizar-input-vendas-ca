<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Connect ‚Äî Painel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #232323;
    --border: #2e2e2e;
    --accent: #00e5a0;
    --accent-dim: rgba(0,229,160,0.12);
    --danger: #ff4f4f;
    --warn: #f5a623;
    --text: #e8e8e8;
    --muted: #666;
    --radius: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; min-height: 100vh; }

  /* LAYOUT */
  .app { display: flex; min-height: 100vh; }
  .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px 0; flex-shrink: 0; display: flex; flex-direction: column; }
  .main { flex: 1; overflow-y: auto; }

  /* SIDEBAR */
  .logo { padding: 0 20px 24px; border-bottom: 1px solid var(--border); }
  .logo h1 { font-size: 13px; font-weight: 600; letter-spacing: .05em; text-transform: uppercase; color: var(--accent); }
  .logo p { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .nav { padding: 16px 0; flex: 1; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; cursor: pointer; color: var(--muted); font-size: 13px; font-weight: 500; transition: all .15s; border-left: 2px solid transparent; }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: var(--accent-dim); }
  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  /* COMPANY SELECTOR */
  .company-selector { padding: 12px; border-top: 1px solid var(--border); }
  .company-selector select { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: var(--radius); font-size: 12px; cursor: pointer; }

  /* PAGE */
  .page { display: none; padding: 32px; max-width: 960px; }
  .page.active { display: block; }
  .page-header { margin-bottom: 28px; }
  .page-header h2 { font-size: 22px; font-weight: 600; }
  .page-header p { color: var(--muted); margin-top: 4px; font-size: 13px; }

  /* CARDS */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .card-title { font-size: 12px; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }

  /* STATS */
  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
  .stat { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; }
  .stat-value { font-size: 28px; font-weight: 600; font-family: 'DM Mono', monospace; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 2px; text-transform: uppercase; letter-spacing: .05em; }

  /* TABLE */
  table { width: 100%; border-collapse: collapse; }
  th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* BADGE */
  .badge { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 20px; }
  .badge-green { background: rgba(0,229,160,.15); color: var(--accent); }
  .badge-red { background: rgba(255,79,79,.15); color: var(--danger); }
  .badge-yellow { background: rgba(245,166,35,.15); color: var(--warn); }
  .badge-gray { background: rgba(255,255,255,.08); color: var(--muted); }

  /* BUTTONS */
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all .15s; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #00c98a; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: rgba(255,79,79,.15); color: var(--danger); border: 1px solid rgba(255,79,79,.3); }
  .btn-danger:hover { background: rgba(255,79,79,.25); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn:disabled { opacity: .4; cursor: not-allowed; }
  .btn-group { display: flex; gap: 8px; }

  /* FORMS */
  .form-group { margin-bottom: 16px; }
  label { font-size: 12px; font-weight: 500; color: var(--muted); display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .04em; }
  input, select, textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px; border-radius: var(--radius); font-size: 13px; font-family: inherit; transition: border-color .15s; }
  input:focus, select:focus { outline: none; border-color: var(--accent); }

  /* UPLOAD ZONE */
  .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 40px; text-align: center; cursor: pointer; transition: all .2s; }
  .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: var(--accent-dim); }
  .upload-zone-icon { font-size: 32px; margin-bottom: 12px; }
  .upload-zone p { color: var(--muted); font-size: 13px; }
  .upload-zone strong { color: var(--accent); }

  /* TOAST */
  .toast-container { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
  .toast { background: var(--surface); border: 1px solid var(--border); padding: 12px 16px; border-radius: var(--radius); font-size: 13px; max-width: 340px; box-shadow: 0 4px 20px rgba(0,0,0,.4); animation: slideIn .2s ease; }
  .toast-success { border-left: 3px solid var(--accent); }
  .toast-error { border-left: 3px solid var(--danger); }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: flex; align-items: center; justify-content: center; z-index: 100; display: none; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 28px; width: 480px; max-width: 95vw; }
  .modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 20px; }

  /* LOADING */
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.2); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-detail { background: rgba(255,79,79,.08); border: 1px solid rgba(255,79,79,.2); border-radius: var(--radius); padding: 10px 12px; font-size: 12px; color: #ff8888; font-family: 'DM Mono', monospace; margin-top: 6px; }
  .empty-state { text-align: center; padding: 48px; color: var(--muted); }
  .empty-state-icon { font-size: 36px; margin-bottom: 12px; }
  .section-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <h1>CA Automa√ß√£o</h1>
      <p>Vendas ‚Üí Conta Azul</p>
    </div>
    <nav class="nav">
      <div class="nav-item active" onclick="showPage('dashboard')">
        <span class="nav-icon">üìä</span> Dashboard
      </div>
      <div class="nav-item" onclick="showPage('upload')">
        <span class="nav-icon">üì§</span> Upload
      </div>
      <div class="nav-item" onclick="showPage('batches')">
        <span class="nav-icon">üì¶</span> Lotes
      </div>
      <div class="nav-item" onclick="showPage('config')">
        <span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes
      </div>
    </nav>
    <div class="company-selector" id="companySelectorWrap">
      <select id="companySelect" onchange="onCompanyChange()">
        <option value="">Carregando...</option>
      </select>
      <div id="companyFixed" style="display:none;padding:8px 4px;font-size:13px;font-weight:600;color:var(--text)"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>Vis√£o geral das vendas e configura√ß√µes</p>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="stat-total">‚Äî</div>
          <div class="stat-label">Total de Vendas</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-enviadas">‚Äî</div>
          <div class="stat-label">Enviadas ao CA</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-erros" style="color:var(--danger)">‚Äî</div>
          <div class="stat-label">Com Erro</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Status da Empresa</div>
        <div id="company-status">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Mapeamento de Contas</div>
        <div id="payment-mapping-summary">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div id="page-upload" class="page">
      <div class="page-header">
        <h2>Upload de Planilha</h2>
        <p>Envie uma planilha Excel com as vendas</p>
      </div>
      <div class="card">
        <div class="form-group">
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-zone-icon">üìÇ</div>
            <p><strong>Clique para selecionar</strong> ou arraste a planilha aqui</p>
            <p style="margin-top:6px;font-size:12px">Formatos aceitos: .xlsx</p>
          </div>
          <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="onFileSelect(event)">
        </div>
        <div id="upload-file-info" style="display:none" class="form-group">
          <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:var(--radius)">
            <span>üìÑ</span>
            <span id="upload-filename" style="flex:1;font-size:13px"></span>
            <button class="btn btn-secondary btn-sm" onclick="clearFile()">‚úï Remover</button>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnUpload" onclick="doUpload()" disabled>
            üì§ Enviar Planilha
          </button>
        </div>
        <div id="upload-result" style="margin-top:16px;display:none"></div>
      </div>
    </div>

    <!-- BATCHES -->
    <div id="page-batches" class="page">
      <div class="page-header">
        <div class="section-row">
          <div>
            <h2>Lotes de Vendas</h2>
            <p style="margin-top:4px;color:var(--muted);font-size:13px">Gerencie os lotes enviados</p>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="loadBatches()">üîÑ Atualizar</button>
        </div>
      </div>
      <div id="batches-list">
        <div class="empty-state"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- CONFIG -->
    <div id="page-config" class="page">
      <div class="page-header">
        <h2>Configura√ß√µes</h2>
        <p>Configure contas financeiras por forma de pagamento</p>
      </div>

      <!-- Contas dispon√≠veis -->
      <div class="card">
        <div class="card-title">Contas Financeiras no Conta Azul</div>
        <div id="ca-accounts-list">
          <button class="btn btn-secondary btn-sm" onclick="loadCAAccounts()">Carregar contas do CA</button>
        </div>
      </div>

      <!-- Mapeamento -->
      <div class="card">
        <div class="section-row">
          <div class="card-title" style="margin:0">Mapeamento Forma de Pagamento ‚Üí Conta</div>
          <button class="btn btn-secondary btn-sm" onclick="loadPaymentMappings()">üîÑ</button>
        </div>
        <div id="payment-mappings-list" style="margin-bottom:16px">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openMappingModal()">+ Adicionar Mapeamento</button>
      </div>

      <!-- Conta padr√£o -->
      <div class="card">
        <div class="card-title">Conta Financeira Padr√£o (Fallback)</div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">Usada quando n√£o h√° mapeamento espec√≠fico</p>
        <div class="form-group">
          <label>UUID da Conta</label>
          <input type="text" id="defaultAccountInput" placeholder="Cole o UUID da conta financeira">
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveDefaultAccount()">Salvar Conta Padr√£o</button>
      </div>

      <!-- Produto Padr√£o (NOVO) -->
      <div class="card">
        <div class="card-title">‚ö†Ô∏è Produto/Servi√ßo Padr√£o <span style="color:var(--danger);font-size:11px">(OBRIGAT√ìRIO)</span></div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">Todas as vendas ser√£o registradas com este produto. Configure antes de enviar vendas.</p>
        
        <div id="products-list" style="margin-bottom:16px">
          <button class="btn btn-secondary btn-sm" onclick="loadCAProducts()">üì¶ Carregar Produtos do CA</button>
        </div>
        
        <div class="form-group">
          <label>Produto Selecionado</label>
          <select id="defaultProductSelect" style="margin-bottom:8px">
            <option value="">-- Selecione um produto --</option>
          </select>
        </div>
        
        <button class="btn btn-primary btn-sm" onclick="saveDefaultProduct()">‚úÖ Salvar Produto Padr√£o</button>
      </div>

      <!-- OAuth -->
      <div class="card">
        <div class="card-title">Autentica√ß√£o Conta Azul</div>
        <p style="color:var(--muted);font-size:12px;margin-bottom:14px">Autorize o acesso ao Conta Azul da empresa</p>
        <button class="btn btn-secondary" onclick="doOAuth()">üîê Autorizar Conta Azul</button>
      </div>
    </div>

  </main>
</div>

<!-- MODAL MAPEAMENTO -->
<div class="modal-overlay" id="mappingModal">
  <div class="modal">
    <h3>Configurar Mapeamento</h3>
    <div class="form-group">
      <label>Forma de Pagamento</label>
      <select id="mappingKey">
        <option value="PIX">PIX</option>
        <option value="CARTAO_CREDITO">Cart√£o de Cr√©dito</option>
        <option value="CARTAO_DEBITO">Cart√£o de D√©bito</option>
        <option value="BOLETO">Boleto</option>
        <option value="TRANSFERENCIA">Transfer√™ncia</option>
        <option value="DINHEIRO">Dinheiro</option>
        <option value="OUTRO">Outro</option>
      </select>
    </div>
    <div class="form-group">
      <label>Conta Financeira (UUID)</label>
      <select id="mappingAccount">
        <option value="">Selecione uma conta...</option>
      </select>
    </div>
    <div class="form-group">
      <label>Label (opcional)</label>
      <input type="text" id="mappingLabel" placeholder="Ex: Stone PIX">
    </div>
    <div class="btn-group" style="margin-top:8px">
      <button class="btn btn-primary" onclick="saveMapping()">Salvar</button>
      <button class="btn btn-secondary" onclick="closeMappingModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = '';  // vazio = mesma origem

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentCompanyId = null;
let caAccounts = [];

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {
  await loadCompanies();
  setupUploadZone();
});

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  event.currentTarget.classList.add('active');
  
  if (page === 'dashboard') loadDashboard();
  if (page === 'batches') loadBatches();
  if (page === 'config') { loadCAAccounts(); loadPaymentMappings(); loadDefaultAccount(); }
}

// ‚îÄ‚îÄ‚îÄ COMPANY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCompanies() {
  try {
    const res = await fetch(`${API}/v1/companies`);
    const companies = await res.json();
    const sel = document.getElementById('companySelect');
    sel.innerHTML = companies.map(c =>
      `<option value="${c.id}" data-slug="${c.slug || ''}">${c.name}</option>`
    ).join('');

    // Auto-seleciona pelo slug da URL (ex: /painel/body-face)
    const pathParts = window.location.pathname.split('/painel/');
    const pathSlug = pathParts.length > 1 ? pathParts[1].replace(/\/$/,'') : '';
    let matched = false;
    if (pathSlug) {
      const toSlug = s => (s||'').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
      const company = companies.find(c => c.slug === pathSlug)
                   || companies.find(c => toSlug(c.name) === pathSlug);
      if (company) {
        sel.value = String(company.id);
        currentCompanyId = String(company.id);
        matched = true;
      }
    }
    if (!matched && companies.length > 0) {
      sel.value = String(companies[0].id);
      currentCompanyId = String(companies[0].id);
    }
    // Se veio por slug: esconde dropdown e mostra nome fixo
    if (pathSlug && matched) {
      const company = companies.find(c => String(c.id) === String(currentCompanyId));
      document.getElementById('companySelect').style.display = 'none';
      const fixed = document.getElementById('companyFixed');
      fixed.style.display = 'block';
      fixed.textContent = company ? company.name : '';
    }
    loadDashboard();
  } catch(e) {
    toast('Erro ao carregar empresas', 'error');
  }
}

function onCompanyChange() {
  currentCompanyId = document.getElementById('companySelect').value;
  loadDashboard();
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  if (!currentCompanyId) return;
  
  try {
    const [salesRes, companyRes, mappingRes] = await Promise.all([
      fetch(`${API}/v1/sales?company_id=${currentCompanyId}`),
      fetch(`${API}/v1/companies/${currentCompanyId}`),
      fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts`),
    ]);
    
    const sales = await salesRes.json();
    const company = await companyRes.json();
    const mapping = await mappingRes.json();
    
    // Stats
    const total = sales.length;
    const enviadas = sales.filter(s => s.status === 'ENVIADA_CA').length;
    const erros = sales.filter(s => s.status === 'ERRO_ENVIO_CA').length;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-enviadas').textContent = enviadas;
    document.getElementById('stat-erros').textContent = erros;
    
    // Status empresa
    const hasToken = company.has_token;
    const hasAccount = company.ca_financial_account_id;
    document.getElementById('company-status').innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;align-items:center;gap:10px">
          ${hasToken ? '<span class="badge badge-green">‚úì OAuth Ativo</span>' : '<span class="badge badge-red">‚úó Sem OAuth</span>'}
          ${hasAccount ? '<span class="badge badge-green">‚úì Conta Padr√£o</span>' : '<span class="badge badge-yellow">‚ö† Sem Conta Padr√£o</span>'}
          <span style="color:var(--muted);font-size:12px">${company.name}</span>
        </div>
        ${!hasToken ? `<a href="/api/contaazul/start?company_id=${currentCompanyId}" target="_blank" class="btn btn-secondary btn-sm" style="width:fit-content">üîê Autorizar Conta Azul</a>` : ''}
      </div>`;
    
    // Mapeamentos
    const maps = mapping.mappings || [];
    if (maps.length === 0) {
      document.getElementById('payment-mapping-summary').innerHTML =
        '<p style="color:var(--warn);font-size:13px">‚ö†Ô∏è Nenhum mapeamento configurado. Configure em Configura√ß√µes.</p>';
    } else {
      const labels = { PIX:'PIX', CARTAO_CREDITO:'Cart√£o Cr√©dito', CARTAO_DEBITO:'Cart√£o D√©bito', BOLETO:'Boleto', TRANSFERENCIA:'Transfer√™ncia', DINHEIRO:'Dinheiro', OUTRO:'Outro' };
      document.getElementById('payment-mapping-summary').innerHTML = `
        <table>
          <tr><th>Pagamento</th><th>Conta (UUID)</th><th>Label</th></tr>
          ${maps.map(m => `<tr>
            <td><span class="badge badge-gray">${labels[m.payment_method_key] || m.payment_method_key}</span></td>
            <td><code style="font-size:11px;color:var(--muted)">${m.ca_financial_account_id.substring(0,18)}...</code></td>
            <td>${m.label || '‚Äî'}</td>
          </tr>`).join('')}
        </table>`;
    }
  } catch(e) {
    console.error(e);
  }
}

// ‚îÄ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedFile = null;

function setupUploadZone() {
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if (file) setFile(file);
  });
}

function onFileSelect(e) {
  const file = e.target.files[0];
  if (file) setFile(file);
}

function setFile(file) {
  selectedFile = file;
  document.getElementById('upload-filename').textContent = file.name;
  document.getElementById('upload-file-info').style.display = 'block';
  document.getElementById('btnUpload').disabled = false;
}

function clearFile() {
  selectedFile = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('upload-file-info').style.display = 'none';
  document.getElementById('btnUpload').disabled = true;
  document.getElementById('upload-result').style.display = 'none';
}

async function doUpload() {
  if (!selectedFile || !currentCompanyId) return;
  const btn = document.getElementById('btnUpload');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Enviando...';

  const fd = new FormData();
  fd.append('company_id', currentCompanyId);
  fd.append('file', selectedFile);

  try {
    const res = await fetch(`${API}/v1/uploads`, { method: 'POST', body: fd });
    const data = await res.json();

    if (!res.ok) {
      // Tratamento especial para config incompleta
      if (data.detail && data.detail.includes('config_incomplete')) {
        const msg = data.detail.replace('config_incomplete: ', '');
        document.getElementById('upload-result').style.display = 'block';
        document.getElementById('upload-result').innerHTML = `
          <div class="error-detail">
            <strong>‚ö†Ô∏è Configura√ß√£o Incompleta</strong><br>
            ${msg}<br><br>
            <button class="btn btn-primary btn-sm" onclick="showPage('config')">Ir para Configura√ß√µes</button>
          </div>`;
        throw new Error(msg);
      }
      throw new Error(data.detail || 'Erro no upload');
    }

    document.getElementById('upload-result').style.display = 'block';
    document.getElementById('upload-result').innerHTML = `
      <div class="card" style="background:var(--accent-dim);border-color:var(--accent)">
        <div style="font-weight:600;margin-bottom:10px;color:var(--accent)">‚úÖ Upload realizado!</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
          <div>üì¶ Lote: <strong>#${data.batch_id}</strong></div>
          <div>üìã Vendas criadas: <strong>${data.sales_created}</strong></div>
          <div>‚è≥ Aguardando aprova√ß√£o: <strong>${data.awaiting_approval}</strong></div>
          <div style="color:${data.with_error > 0 ? 'var(--danger)' : 'inherit'}">‚ùå Com erro: <strong>${data.with_error}</strong></div>
        </div>
        ${data.awaiting_approval > 0 ? `
        <div style="margin-top:14px;display:flex;gap:8px">
          <button class="btn btn-primary btn-sm" onclick="quickApprove(${data.batch_id})">‚úì Aprovar Lote #${data.batch_id}</button>
          <button class="btn btn-secondary btn-sm" onclick="showPage('batches');loadBatches()">Ver Lotes</button>
        </div>` : ''}
      </div>`;

    toast(`‚úÖ ${data.sales_created} vendas criadas no lote #${data.batch_id}`, 'success');
    clearFile();
  } catch(e) {
    toast(e.message, 'error');
    if (!document.getElementById('upload-result').innerHTML.includes('Configura√ß√£o Incompleta')) {
      document.getElementById('upload-result').style.display = 'block';
      document.getElementById('upload-result').innerHTML = `<div class="error-detail">${e.message}</div>`;
    }
  } finally {
    btn.innerHTML = 'üì§ Enviar Planilha';
    btn.disabled = false;
  }
}

async function quickApprove(batchId) {
  try {
    const res = await fetch(`${API}/v1/batches/${batchId}/approve`, { method: 'POST', body: '' });
    const data = await res.json();
    toast(`‚úÖ ${data.approved} vendas aprovadas`, 'success');
    loadDashboard();
  } catch(e) {
    toast('Erro ao aprovar', 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ BATCHES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBatches() {
  if (!currentCompanyId) return;
  const container = document.getElementById('batches-list');
  container.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';

  try {
    const res = await fetch(`${API}/v1/sales?company_id=${currentCompanyId}`);
    const sales = await res.json();

    if (sales.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Nenhuma venda encontrada</p></div>';
      return;
    }

    // Agrupa por batch
    const batches = {};
    sales.forEach(s => {
      if (!batches[s.batch_id]) batches[s.batch_id] = { id: s.batch_id, sales: [] };
      batches[s.batch_id].sales.push(s);
    });

    container.innerHTML = Object.values(batches).reverse().map(b => {
      const total = b.sales.length;
      const enviadas = b.sales.filter(s => s.status === 'ENVIADA_CA').length;
      const erros = b.sales.filter(s => s.status === 'ERRO_ENVIO_CA').length;
      const prontas = b.sales.filter(s => s.status === 'PRONTA').length;
      const aguardando = b.sales.filter(s => s.status === 'AGUARDANDO_APROVACAO').length;

      return `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
          <div>
            <div style="font-weight:600;font-size:15px">Lote #${b.id}</div>
            <div style="color:var(--muted);font-size:12px;margin-top:2px">${total} vendas</div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
            ${enviadas > 0 ? `<span class="badge badge-green">‚úì ${enviadas} enviadas</span>` : ''}
            ${erros > 0 ? `<span class="badge badge-red">‚úó ${erros} erros</span>` : ''}
            ${prontas > 0 ? `<span class="badge badge-gray">‚è© ${prontas} prontas</span>` : ''}
            ${aguardando > 0 ? `<span class="badge badge-yellow">‚è≥ ${aguardando} aguardando</span>` : ''}
          </div>
        </div>
        <div class="btn-group">
          ${aguardando > 0 ? `<button class="btn btn-secondary btn-sm" onclick="approveBatch(${b.id})">‚úì Aprovar (${aguardando})</button>` : ''}
          ${prontas > 0 ? `<button class="btn btn-primary btn-sm" onclick="sendBatch(${b.id}, this)">üöÄ Enviar ao CA (${prontas})</button>` : ''}
          ${erros > 0 ? `<button class="btn btn-danger btn-sm" onclick="toggleErrors(${b.id})">Ver erros</button>` : ''}
        </div>
        <div id="errors-${b.id}" style="display:none;margin-top:14px">
          ${b.sales.filter(s => s.status === 'ERRO_ENVIO_CA').map(s => `
            <div style="margin-bottom:8px">
              <div style="font-size:13px;font-weight:500">${s.customer_name} ‚Äî R$ ${parseFloat(s.total_amount).toFixed(2)}</div>
              <div class="error-detail">${s.error_summary || 'Sem detalhes'}</div>
            </div>`).join('')}
        </div>
      </div>`;
    }).join('');

  } catch(e) {
    container.innerHTML = `<div class="error-detail">${e.message}</div>`;
  }
}

function toggleErrors(batchId) {
  const el = document.getElementById('errors-' + batchId);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function approveBatch(batchId) {
  try {
    const res = await fetch(`${API}/v1/batches/${batchId}/approve`, { method: 'POST', body: '' });
    const data = await res.json();
    toast(`‚úÖ ${data.approved} vendas aprovadas`, 'success');
    loadBatches();
  } catch(e) {
    toast('Erro ao aprovar', 'error');
  }
}

async function sendBatch(batchId, btn) {
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Enviando...';
  try {
    const res = await fetch(`${API}/v1/batches/${batchId}/send_to_ca`, { method: 'POST', body: '' });
    const data = await res.json();
    if (data.errors > 0) {
      toast(`‚ö†Ô∏è ${data.sent} enviadas, ${data.errors} erros`, 'error');
    } else {
      toast(`‚úÖ ${data.sent} vendas enviadas ao Conta Azul!`, 'success');
    }
    loadBatches();
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  } finally {
    btn.innerHTML = 'üöÄ Enviar ao CA';
    btn.disabled = false;
  }
}

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCAAccounts() {
  if (!currentCompanyId) return;
  const el = document.getElementById('ca-accounts-list');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/ca/financial-accounts`);
    const data = await res.json();
    caAccounts = data.itens || data || [];

    // Atualiza select do modal
    const sel = document.getElementById('mappingAccount');
    sel.innerHTML = '<option value="">Selecione...</option>' +
      caAccounts.filter(a => a.ativo).map(a =>
        `<option value="${a.id}">${a.nome} (${a.tipo})</option>`
      ).join('');

    el.innerHTML = `
      <table>
        <tr><th>Nome</th><th>Tipo</th><th>UUID</th><th>Status</th></tr>
        ${caAccounts.map(a => `<tr>
          <td>${a.nome}</td>
          <td><span class="badge badge-gray">${a.tipo}</span></td>
          <td><code style="font-size:11px;color:var(--muted)">${a.id}</code></td>
          <td>${a.ativo ? '<span class="badge badge-green">Ativa</span>' : '<span class="badge badge-gray">Inativa</span>'}</td>
        </tr>`).join('')}
      </table>`;
  } catch(e) {
    el.innerHTML = `<div class="error-detail">${e.message}</div>`;
  }
}

async function loadPaymentMappings() {
  if (!currentCompanyId) return;
  const el = document.getElementById('payment-mappings-list');
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts`);
    const data = await res.json();
    const maps = data.mappings || [];

    if (maps.length === 0) {
      el.innerHTML = '<p style="color:var(--muted);font-size:13px">Nenhum mapeamento configurado.</p>';
      return;
    }

    const labels = { PIX:'PIX', CARTAO_CREDITO:'Cart√£o Cr√©dito', CARTAO_DEBITO:'Cart√£o D√©bito',
                     BOLETO:'Boleto', TRANSFERENCIA:'Transfer√™ncia', DINHEIRO:'Dinheiro', OUTRO:'Outro' };

    el.innerHTML = `
      <table>
        <tr><th>Pagamento</th><th>Label</th><th>Conta (UUID)</th><th></th></tr>
        ${maps.map(m => `<tr>
          <td><span class="badge badge-gray">${labels[m.payment_method_key] || m.payment_method_key}</span></td>
          <td>${m.label || '‚Äî'}</td>
          <td><code style="font-size:11px;color:var(--muted)">${m.ca_financial_account_id.substring(0,22)}...</code></td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteMapping('${m.payment_method_key}')">‚úï</button></td>
        </tr>`).join('')}
      </table>`;
  } catch(e) {
    el.innerHTML = `<div class="error-detail">${e.message}</div>`;
  }
}

async function loadDefaultAccount() {
  if (!currentCompanyId) return;
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`);
    const c = await res.json();
    if (c.ca_financial_account_id) {
      document.getElementById('defaultAccountInput').value = c.ca_financial_account_id;
    }
  } catch(e) {}
}

async function saveDefaultAccount() {
  const uuid = document.getElementById('defaultAccountInput').value.trim();
  if (!uuid) return toast('Informe o UUID da conta', 'error');
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/ca/financial-account`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ca_financial_account_id: uuid })
    });
    if (!res.ok) throw new Error('Erro ao salvar');
    toast('‚úÖ Conta padr√£o salva!', 'success');
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  }
}

// ===== PRODUTOS (NOVO) =====
async function loadCAProducts() {
  if (!currentCompanyId) return;
  const el = document.getElementById('products-list');
  el.innerHTML = '<div class="spinner"></div>';
  
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/ca/products?busca=`);
    if (!res.ok) throw new Error('Erro ao carregar produtos');
    
    const data = await res.json();
    const products = data.items || data.itens || [];
    
    if (products.length === 0) {
      el.innerHTML = '<div class="error-detail">‚ö†Ô∏è Nenhum produto encontrado. Crie produtos no Conta Azul primeiro.</div>';
      return;
    }
    
    // Atualiza select
    const sel = document.getElementById('defaultProductSelect');
    sel.innerHTML = '<option value="">-- Selecione um produto --</option>' +
      products.map(p => 
        `<option value="${p.id}">${p.name || p.description || p.nome} ${p.code ? '(' + p.code + ')' : ''}</option>`
      ).join('');
    
    // Mostra lista
    el.innerHTML = `
      <table>
        <tr><th>Nome/Descri√ß√£o</th><th>C√≥digo</th><th>UUID</th></tr>
        ${products.map(p => `<tr>
          <td>${p.name || p.description || p.nome || '-'}</td>
          <td>${p.code || p.cnaeCode || '-'}</td>
          <td><code style="font-size:10px;color:var(--muted)">${p.id}</code></td>
        </tr>`).join('')}
      </table>`;
    
    toast(`${products.length} produto(s) carregado(s)`, 'success');
  } catch(e) {
    el.innerHTML = `<div class="error-detail">${e.message}</div>`;
    toast('Erro ao carregar produtos', 'error');
  }
}

async function saveDefaultProduct() {
  const productId = document.getElementById('defaultProductSelect').value;
  if (!productId) return toast('Selecione um produto', 'error');
  
  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ default_item_id: productId })
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Erro ao salvar');
    }
    
    toast('‚úÖ Produto padr√£o configurado!', 'success');
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  }
}
// ===== FIM PRODUTOS =====

function openMappingModal() {
  document.getElementById('mappingModal').classList.add('open');
}
function closeMappingModal() {
  document.getElementById('mappingModal').classList.remove('open');
}

async function saveMapping() {
  const key = document.getElementById('mappingKey').value;
  const accountId = document.getElementById('mappingAccount').value;
  const label = document.getElementById('mappingLabel').value;

  if (!accountId) return toast('Selecione uma conta', 'error');

  try {
    const res = await fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payment_method_key: key, ca_financial_account_id: accountId, label: label || null })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Erro');
    }
    toast('‚úÖ Mapeamento salvo!', 'success');
    closeMappingModal();
    loadPaymentMappings();
    loadDashboard();
  } catch(e) {
    toast(e.message, 'error');
  }
}

async function deleteMapping(key) {
  try {
    await fetch(`${API}/v1/companies/${currentCompanyId}/payment-accounts/${key}`, { method: 'DELETE' });
    toast(`üóëÔ∏è Mapeamento ${key} removido`, 'success');
    loadPaymentMappings();
    loadDashboard();
  } catch(e) {
    toast('Erro ao remover', 'error');
  }
}

function doOAuth() {
  if (!currentCompanyId) return toast('Selecione uma empresa', 'error');
  window.open(`/api/contaazul/start?company_id=${currentCompanyId}`, '_blank');
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type = 'success') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}
</script>
</body>
</html>
